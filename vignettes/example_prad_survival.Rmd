---
title: "Example for Survival Data -- Prostate Adenocarcinoma"
author: "Marta Lopes and André Veríssimo"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    number_sections: yes
    toc: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Example for Survival Data -- Prostate Adenocarcinoma}
  %\VignetteEncoding{UTF-8}
params:
  seed: !r 2924
--- 

## Instalation

```{r, eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite('glmSparseNet')
```

# Required Packages

```{r packages, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(survival)
library(ggfortify)
library(loose.rock)
library(futile.logger)
#
library(glmSparseNet)
#
# Some general options for futile.logger the debugging package
.Last.value <- flog.layout(layout.format('[~l] ~m'))
.Last.value <- loose.rock::show.message(FALSE)
# Setting ggplot2 default theme as minimal
theme_set(ggplot2::theme_minimal())
```

# Load data

The data is loaded from an online curated dataset downloaded from TCGA using `TCGAbiolinks` bioconductor package and processed.

To accelerate the process we use a very reduced dataset down to around 100 variables only *(genes)*, which is stored as a data object in this package. However, the procedure to obtain the data manually is described in the following chunk.

```{r data.show, eval=FALSE}
# download data package with TCGA data
biocLite('https://github.com/averissimo/tcga.data/releases/download/2017.07.21-prad/prad.data_1.0.tar.gz')

library(prad.data)
# short example
my.data <- prepare.tcga.survival.data(project           = 'prad', 
                                      tissue.type       = 'primary.solid.tumor', 
                                      handle.duplicates = 'keep_first', 
                                      coding.genes      = TRUE)

# Using only a subset of genes previously selected to keep this short example.

set.seed(params$seed)
small.subset <- c('ENSG00000103091', 'ENSG00000064787', 'ENSG00000119915', 
                  'ENSG00000100744', 'ENSG00000120158', 'ENSG00000114491', 
                  'ENSG00000204176', 'ENSG00000138399', 
                  sample(colnames(my.data$xdata), 100)) %>% unique
xdata <- my.data$xdata[,small.subset]
ydata <- my.data$ydata
```

```{r, include=FALSE, eval=FALSE}
# save data in package
sample.PRAD.survival <- list(xdata = xdata, ydata = ydata)
devtools::use_data(sample.PRAD.survival, overwrite = TRUE)
```

```{r, include=FALSE}
xdata <- sample.PRAD.survival$xdata
ydata <- sample.PRAD.survival$ydata
```

# Fit models

Fit model model penalizing by the hubs using the cross-validation function by `cv.glmHub`.

```{r fit}
fitted <- cv.glmHub(xdata, Surv(ydata$time, ydata$status), 
                    family  = 'cox',
                    network = 'correlation',
                    nlambda = 1000)
```

# Results of Cross Validation

Shows the results of `100` different parameters used to find the optimal value in 10-fold cross-validation. The two vertical dotted lines represent the best model and a model with less variables selected *(genes)*, but within a standard error distance from the best.

```{r results}
plot(fitted)
```

## Coefficients of selected model from Cross-Validation

Taking the best model described by `lambda.min`

```{r show_coefs}
coefs.v <- coef(fitted, s = 'lambda.min')[,1] %>% { .[. != 0]}
coefs.v %>% { 
  data.frame(ensembl.id  = names(.), 
             gene.name   = gene.names(names(.))$external_gene_name, 
             coefficient = .,
             stringsAsFactors = FALSE)
  } %>%
  arrange(gene.name) %>%
  knitr::kable()
```

## Hallmarks of Cancer

```{r hallmarks}
gene.names(names(coefs.v)) %>% { hallmarks(.$external_gene_name)$heatmap }
```

## Survival curves and Log rank test

```{r}
draw.kaplan(as.vector(coefs.v), 
            xdata[, names(coefs.v)], 
            ydata, 
            plot.title = 'Full dataset', legend.outside = F)
```

